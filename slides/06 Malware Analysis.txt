IT Security
MalwareAnalysis
TimoPohl
pohl@cs.uni-bonn.de
UniversityofBonn|InstituteofComputerScience4
LectureITSecurity| UniBonn| WT2024/25
Contents
Motivation
GettingInfected
PDFAnalysis
PEAnalysis
Obfuscation
Anti-Debugging
Anti-Sandboxing
Outlook
1/71
Motivation
Thereisafullmoduleonmalwareanalysis
Thisisaspeedrunthroughsomeinterestingtopics
Ifyou’reinterested,visitthemodule
2/71
Why Malware Analysis?
3/71
Why Malware Analysis?
Findouthowmalwareworks
Stopongoingcampaigns
Developcountermeasures
4/71
Getting Infected
Motivation
GettingInfected
PDFAnalysis
PEAnalysis
Obfuscation
Anti-Debugging
Anti-Sandboxing
Outlook
5/71
Getting infected
PDFs
Phishing
Maliciousupdates
Officemacros
…
6/71
PDFs show Documents!
7/71
PDFs are interactive.
8/71
PDFs… run code?
9/71
PDFs are (mostly) readable
10/71
PDF Structure
Largecollectionofobjects
Mostlyreadable
Directobjectslike1,(hello)or[null true false]
Indirectobjectsstartingwith<ID> <Gen-No> objandendingwithendobj
11/71
PDF Structure Example
12/71
Common Object Types
Nameobjects—/Name,/anything
Referenceobjects—8 0 R
Strings—(as literals)or<68656c6c6f>hexencoded
Numbers—0or123994
Arrays—[(hello) /world]
Dictionaries—<</Key1 /AnyObj /Key2 8 0 R>>
13/71
PDF Types Example
14/71
Start of a PDF
15/71
PDF Interactive Features
PDF Action Dictionaries
16/71
PDF Interesting Actions
/Launch
/JavaScript
Launchanapplication. ExecuteJavaScript. Send
/SubmitForm
datatoaspecifiedURL.OpenaURI.
/URI
17/71
PDF OpenAction
18/71
PDF OpenAction
PDFshaveCatalogdictionaries
Catalogdictionaryhas“contentcatalog”
OpenActiondefinedinCatalogdictionary
OpenActionexecutedwhenopeningdocument
18/71
PDF Full Example
19/71
PDF Full Example
Westartatbyteoffset754
Pointsatobject10 0
Rootdictpointsatobject9 0
19/71
PDF Full Example
19/71
PDF Full Example
Object9 0isCatalogdictionary
Haspagesobjectat1 0
19/71
PDF Full Example
19/71
PDF Full Example
Pagesobjectshowsonepageobjectat8 0
Resourcesobject3 0isirrelevantforus
19/71
PDF Full Example
19/71
PDF Full Example
Parentsobjectiswherewecomefrom
Contentsobjectat4 0definespagecontent
Annotsobjectdefinesannotations
Annotationdefinesanactionat6 0
19/71
PDF Full Example
19/71
PDF Full Example
Contentobjecthasnorelevantinformationforus
Weseethedisplayedtextinthebytestream
19/71
PDF Full Example
19/71
PDF Full Example
Annotationactionisindeedanactiondict
ContainsaLaunchaction
Launches/tmp/malware.py
19/71
PDFs can be “obfuscated”
Differentstringrepresentation
Streamcompression
Objectencryption
20/71
PDF analysis
Yourfavouritetexteditor
qpdffor“deobfuscation”
peepdfforaquickoverview
21/71
Summary
PDFsarereadableastext
PDFscanperformactions
Analysisisrelativelysimple
MostmainstreamPDFviewersaresecureagainstcommonattacks
22/71
Questions?
PE Analysis
Motivation
GettingInfected
PDFAnalysis
PEAnalysis
Obfuscation
Anti-Debugging
Anti-Sandboxing
Outlook
23/71
Comparison to ELF Analysis
ELFanalysisknownfrompreviouslecture
Windowsmalwareismostprevalent
WindowsusesPEinsteadofELF
stdcallandMicrosoft x64insteadofcdeclorSystem V
x64dbginsteadofgdb
Similartoolsforstaticanalysis(ghidra,ida,binja,…)+someforquickoverviews(PE
Studie,DetectitEasy,…)
Focusonstrings,networkaccess,…—wewanttounderstandbehaviour
24/71
General approach
Goal:understandmalwarebehaviour
Top-Downapproach:startatentrypoint,followcontrolflow
Bottom-Upapproach:searchforinterestingthingslikeAPIcalls,strings,encryption
routines,…andbacktracefromthere
25/71
Obfuscation
Motivation
GettingInfected
PDFAnalysis
PEAnalysis
Obfuscation
Anti-Debugging
Anti-Sandboxing
Outlook
26/71
What is Obfuscation?
“carlini”fromthe27thIOCCC
27/71
Obfuscation techniques
Stringobfuscation
Controlflowobfuscation
Packing
Bloating
…
28/71
Why obfuscate strings?
Stringsoftenhavesensitive/importantinfo
Stringsareeasytolocate
29/71
Unobfuscated example
1 char ip[] = "169.254.0.33";
2 char registry_key[] = "SOFTWARE\\Microsoft\\Windows\\CurrentVersion\\
RunOnce";
3
6 return 1;
7 }
8
10 11 }
4 int steal_content_from_registry(char *ip, char *registry_key) {
5 printf("%s: %s\n", ip, registry_key);
9 int main(void) {
steal_content_from_registry(ip, registry_key);
30/71
Unobfuscated strings are easy to find
31/71
String obfuscation — encryption
1 unsigned char registry_key[] = {161, 189, 180, 166, 165, 179, 160, 183, 174, 191, 155, 145, 128,
2 157, 129, 157, 148, 134, 174, 165, 155, 156, 150, 157, 133, 129,
3 174, 177, 135, 128, 128, 151, 156, 134, 164, 151, 128, 129, 155,
4 157, 156, 174, 160, 135, 156, 189, 156, 145, 151, 0};
5
6 void xor_decrypt(unsigned char key, unsigned char *content) {
7 for (int i = 0; content[i] != 0; ++i) {
8 content[i] = content[i] ^ key;
9 }
10 }
11
12 13 14 15 16 17 }
int main(void) {
unsigned char key = 242;
xor_decrypt(key, registry_key);
printf("%s\n", registry_key);
// prints: SOFTWARE\Microsoft\Windows\CurrentVersion\RunOnce
32/71
String obfuscation — encryption
Stringsarejustarraysofchars
Eachcharcanbeindividuallyencrypted
Differentencryptiontechniquespossible
33/71
String obfuscation — stack strings
1 int main(void) {
2 unsigned int ip_0 = 0;
3 unsigned int ip_1 = 0x33332e30;
4 unsigned int ip_2 = 0x2e343532;
5 unsigned int ip_3 = 0x2e393631;
6
10 }
7 xor_decrypt(key, registry_key);
8 // int steal_content_from_registry(char *ip, char *registry_key) {};
9 steal_content_from_registry((unsigned char *) &ip_3, registry_key);
34/71
String obfuscation — stack strings
Stringsarejustarraysofchars
Arraysarecontinuousareasofmemory
Stackvariablesnexttoeachothercanbeinterpretedasanarray
35/71
Obfuscated strings are hard to find
36/71
Deobfuscation
Staticanalysis
Emulation
Debugger
…
37/71
Deobfuscating stack strings via retyping
38/71
Deobfuscating stack strings via retyping
38/71
Deobfuscating stack strings via retyping
38/71
Deobfuscating stack strings via retyping
38/71
Deobfuscating encrypted strings via
emulation
OriginalCcodefromourexamplemalware:
1 void xor_decrypt(byte param_1, char *param_2) {
2 for (int local_c = 0; param_2[local_c] != '\0'; local_c = local_c + 1) {
3 param_2[local_c] = param_2[local_c] ^ param_1;
4 }
5 }
39/71
Deobfuscating encrypted strings via
emulation
Re-implementedpythonversion:
4 content[i] = content[i] ^ key
5 i += 1
1 def xor_decrypt(key: int, content: list[int]) -> None:
2 i = 0
3 while content[i] != 0:
6
7 secret = [ 161, 189, 180, 166, 165, 179, 160, 183, 174, 191, 155, 145, 128,
8 157, 129, 157, 148, 134, 174, 165, 155, 156, 150, 157, 133, 129,
10 11 12 13 14 9 174, 177, 135, 128, 128, 151, 156, 134, 164, 151, 128, 129, 155,
157, 156, 174, 160, 135, 156, 189, 156, 145, 151, 0 ]
key = 242
xor_decrypt(key, secret)
print(''.join(chr(c) for c in secret))
# >>> SOFTWARE\Microsoft\Windows\CurrentVersion\RunOnce
40/71
Deobfuscating with x64dbg
41/71
Deobfuscating with x64dbg
41/71
Deobfuscating with x64dbg
42/71
Deobfuscating with x64dbg
1 unsigned char registry_key[] = {161, 189, ...};
2
3 int main(void) {
4 unsigned int ip_0 = 0;
5 unsigned int ip_1 = 0x33332e30;
6 unsigned int ip_2 = 0x2e343532;
7 unsigned int ip_3 = 0x2e393631;
8
10 11 }
9 xor_decrypt(key, registry_key);
steal_content_from_registry((unsigned char *) &ip_3, registry_key);
43/71
Deobfuscating with x64dbg
Rununtilweexpecttofindcleartextdata
Functioncallatline10seemslikeagoodcandidate
Usex64dbg’sregistersviewtoextractstrings
Howdoweknowthefunctioncallpositionwithinthebinary?
44/71
Find specific address in x64dbg
45/71
Deobfuscating with x64dbg
46/71
Deobfuscating with x64dbg
Last2bytesofaddressareusuallystatic
Findtheme.g.inghidra
Lookupstartof.textsectioninmemorymaponx64dbg
Setbreakpointatdesiredoffset
Functionargumentsarefoundintheregisterssection
47/71
Summary
Obfuscationmakesanalysishard
Staticanalysiscanhelpforsimplethings
Dynamicanalysiscanbemorepowerful,butalsomorechallenging
Thereisnosilverbullet
48/71
Questions?
Anti-Debugging
Motivation
GettingInfected
PDFAnalysis
PEAnalysis
Obfuscation
Anti-Debugging
Anti-Sandboxing
Outlook
49/71
About Anti-Debugging
Makesdynamicanalysisharder
Varioustechniques
Windows’Win32API
Windowsinternalflags
Many,manysideeffects(seehttps://anti-debug.checkpoint.com)
50/71
Anti-Debug — Windows' Win32 API
Built-InWindowsAPI
FunctionIsDebuggerPresent()fromdebugapi.h
Intendedtoenableapplicationstoprovideadditionalinformation
51/71
Anti-Debug — Windows' Win32 API
1 #include <windows.h>
3 int main(void) {
4 if (IsDebuggerPresent()) {
2
6 } else {
7 do_evil_stuff();
8 }
9 }
5 do_some_evasive_stuff_like_exit();
52/71
Anti-Debug —
Process Environment Block
Containssomeprocesscontextinformation
ForexampletheBeingDebuggedflag
Internalstructure→ nostableAPI
53/71
Anti-Debug — PEB
1 #include <windows.h>
3 int main(void) {
2
6 if (pPeb->BeingDebugged) {
7 do_some_evasive_stuff_like_exit();
8 } else {
9 do_evil_stuff();
10 }
11 }
4 // decompilation shows something like `(unaff_GS_OFFSET + 0x60)`
5 PPEB pPeb = (PPEB)__readgsqword(0x60);
54/71
Anti-Debug Circumvention
Patching
ModifyReturnValues
ScyllaHideforx64DBG
HookAPIcalls
55/71
Anti-Debug Circumvention — Patching
56/71
Anti-Debug Circumvention —
Modify Return Values
57/71
Anti-Debug Circumvention —
Modify Return Values
57/71
Anti-Debug Circumvention — ScyllaHide
58/71
Summary
Anti-Debugtechniques
Use/abusevariousmechanismstodetectdebuggerpresence
Leadtoalternativecodepaths
Anti-Debugcircumvention
Jumpoveranti-debugroutines
Changereturnvaluesofdetectionroutines
Useexistingtools
59/71
Questions?
Anti-Sandboxing
Motivation
GettingInfected
PDFAnalysis
PEAnalysis
Obfuscation
Anti-Debugging
Anti-Sandboxing
Outlook
60/71
Anti-Sandbox Techniques
Filesystem
Processorinstructions
Hardwaredetection
Network
Behaviour
GuestAdditions
…(https://evasions.checkpoint.com)
61/71
Anti-Sandbox — File system artifacts
FilesspecifictoVirtualMachine
System32\drivers\VBoxMouse.sys
System32\drivers\VBoxVideo.sys
…
Binarypathcontainskeywords(“sample”,“malware”,…)
…
62/71
Anti-Sandbox — CPU instructions
CPUIDinstruction
ReturnsCPUinformationlikethevendorname
Insandboxedenvironmentsusuallyasandbox-specificstring
Exoticinstructions
Sandboxesoftendon’timplementallCPUinstructions
Undocumentedinstructions
…
63/71
Anti-Sandbox — Hardware Detection
DeviceNames
Insanboxedenvironmentsusuallysandbox-specific
CPUTemperatureInformation
Sensorsoftennotavailabletosandbox
Audiodeviceavailability
…
64/71
Anti-Sandbox — Device Names
65/71
CPU Temperature Information on Bare
Metal
66/71
CPU Temperature Information in a
Sandbox
67/71
Anti-Sandbox — Mitigations
Existingtools
https://github.com/nsmfoo/antivmdetection
https://github.com/hfiref0x/VBoxHardenedLoader
Painfullydoityourself
Testyourhardeningwithothertools
https://github.com/LordNoteworthy/al-khaser
https://github.com/a0rtega/pafish
68/71
Summary
Therearemany thingsgivingawayasandboxedenvironment
Someareoftechnicalnatureduetotheenvironment
Someareduetotheabsenceofarealuser
Someareduetothehabitsofresearchers
Onlymitigationistoknowthemall(orusetoolsfromauthorsthatdo)
69/71
Questions?
Outlook
Motivation
GettingInfected
PDFAnalysis
PEAnalysis
Obfuscation
Anti-Debugging
Anti-Sandboxing
Outlook
70/71
Outlook
Infectionchains
Payloads
ProcessInjections
Persistence
Muchmoredetail
Realmalware
PracticalNetworkAnalysis
71/71
Timo Pohl
University of Bonn | Institute of Computer Science 4
pohl@cs.uni-bonn.de